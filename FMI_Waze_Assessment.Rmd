---
title: "FMI Waze Cross-Project Assessment"
author: "Dan Flynn, Billy Chupp, Alexis Zubrow"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: true
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

<!-- Add the following line manually to the rendered HTML document so that IE does not block the javascript elements: -->
<!-- saved from url=(0014)about:internet --> 

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggplot2)
library(plotly)
```


```{r setup, cache = TRUE}
d <- readr::read_csv('Data/MA_subset_2019-09-01_2019-09-30_Joined.csv')

d$date <- as.Date(d$day, format = '%Y-%j')

d$datetime <- strptime(paste(d$day, d$hour), format = '%Y-%j %H', tz = 'US/Eastern')

d$day_week <- lubridate::wday(d$datetime, label = TRUE, abbr = FALSE)
d$weekend <- d$day_week == "Saturday" | d$day_week == "Sunday"
d$daytime <- d$hour > '06' & d$hour < '20'


# fix bad speed data
# bad_speed = d[d$speed_mean > 90 & !is.na(d$speed_mean), c('speed_min', 'speed_median', 'speed_mean', 'speed_max')]

d[d$speed_mean > 90 & !is.na(d$speed_mean), c('speed_min', 'speed_median', 'speed_mean', 'speed_max')] = NA

```

# Overview

The Secure Data Commons ([SDC](https://its.dot.gov/data/secure/)) provides access to novel data sets within the Department of Transportation for researchers and partner agencies. Two data sets are used in this work: 

- **FMI Data**: The Freight Mobility Initiative (FMI) data is provided via an agreement between the American Transportation Research Institute (ATRI) and the Bureau of Transportation Statistics (BTS) of the USDOT. This data set includes GPS locations, speed, and direction of travel for anonymized trucks.

- **Waze Data**: The mobile phone navigation app company Waze has been providing data on crowdsourced traffic incident reports and additional system-generated data via an agreement with the DOT. These data include location and time of incidents, along with a number of characteristics of incidents, as well as location, extent, and speed of jams. 

This document summarizes the work of the SDC Cross-project team in assessing how these two data sets can be usefully analyzed together. 

Data set characteristics:

| Characteristic                  |    FMI        |   Waze               | Notes                            |
|---------------------------------|---------------|----------------------|---------------------------------|
| Spatial Range                   |  National     | National             | Waze data organized with state partitions |
| Available Time Range            |  Since October 2018 | Since March 2017 |  Gaps exist for some time periods |
| Volume of data  |  106 B GPS records |   1.6 B alert records </br> 3.4 B jam records </br> 11 B jam point sequence records | As off late April 2020   |
| Update frequency               |  Bi-weekly    | API request every 2 minute  | Both have pipeline processing times, so not available to analysts immediately  |

<!-- 
From Hive: describe extended {table}
From Redshift: select count(*) from {table}
-->


### Main takeaways

- The data can be usefully integrated together. The two data sets provide complementary information on volume and characteristics of crowdsourced traffic incidents, and volume and characteristics of commercial trucking activity. Together, these data could be applied to a number of use cases in roadway safety, roadway system performance, and travel monitoring.

- Through this effort, we developed general-purpose query and data processing scripts in GitLab which can be used by other teams. The code collaboration tools in the SDC provide a means for future analysts to replicate and build on the analysis presented here. This effort leveraged some existing work by other teams (BTS) who had started exploring the FMI data, as well as code from the [Safety Data Initiative Waze pilot project](https://www.transportation.gov/SafetyDataInitiative/Pilots#waze). 

- Successfully integrating these two high-volume, high-velocity data sets requires a familiarity with the characteristics of the data, the data warehousing system, and best practices for geo-spatial analysis. Documentation exists in the SDC to provide much of this necessary information, but future users of these data would benefit from documentation which goes into more detail

- The spatial and temporal patterns of the FMI and Waze data are distinct. 
  + There are locations and times where there is high truck activity but low Waze activity, likely distribution centers and commercial shipping routes.
  + The converse is true; Waze data volume is highest at commuting hours, in more densely populated areas.
  + However, there is useful areas of overlap between these two data sets.

# Methods

Given the vast scale of these data sets, this assessment selected one region of the country, for one month, namely eastern Massachusetts for September 2019. This allows a proof-of-concept assessment of how these data can be joined and analyzed in concert. The process involved the following steps:

## Querying the data warehouse

Both the Waze and FMI data can be queried using standard SQL syntax. The Waze data are warehoused in an Amazon Redshift cluster, while the FMI data are warehoused in a Hive/Hadoop cluster. In practice, the query syntax is similar for both: query the database for a date range and general spatial area, then perform more detailed spatial analysis on the results from the query. In the course of developing the code for this project, we encountered performance issues with the Hive/Hadoop cluster. We worked with the SDC developer team to test improvements to the database structure, which the SDC team has implemented.

The 'two-step' query process (first query a general area in SQL, then perform more detailed spatial data processing on the results) could in theory be simplified to one step. However, this would involve putting much more computational load on the data warehouse infrastructure, as opposed to on a data analyst's own EC2 compute instance in the two-step process. The first spatial step is similar for both: querying for a date range (2019-09-01 to 2019-09-30) and a latitude and longitude range that encompasses eastern Massachusetts (or any region of interest). The second step is also the same: convert to spatial data frames, apply the same geographic projection on the latitude and longitudes, and clip to a shapefile for the state of Massachusetts using standard, open-source geospatial analysis libraries.

## Spatial joining

Joining two spatial datasets involves decisions on the part of the analysis team; the methods depend on the needs of the analysis. The two most meaningful options for this project were to join to road segments, or to join to a common grid structure. These two approaches are summarized below:

- **Road segment**
  + Joining points to road segments result in one row per road segment, with attributes for number and characteristics of commercial motor vehicles, and number and characteristics of traffic alerts. Each time step would add one additional row for each road segment.
  + The Highway Performance Monitoring System ([HPMS](https://www.fhwa.dot.gov/policyinformation/hpms.cfm)) provides an road network for the National Highway System roads. While convenient to use for spatial analyses, it is limited by not including most lower functional class roads.
  + Each state maintains their own detailed road network. It would be possible to access a road network for this study area (Massachusetts), but the methods of spatial joining would need to be adapted to apply to other states.
  + Any analyses need to take into account the different lengths and characteristics of the road segments; correctly joining points to road segments requires careful work to assign points correctly to the right lanes and directions (applicable to higher functional class roads).

- **Grid or Polygon**
  + Joining points to road segments result in one row per grid cell or polygon, with attributes for number and characteristics of commercial motor vehicles, and number and characteristics of traffic alerts. Each time step would add an additional row for each grid cell or polygon.
  + Joining to a county, census block, or other political boundary is straightforward and would facilitate use of other characteristics of that political unit, including population or socio-economic data like the Longitudinal Employer-Household Dynamics ([LEHD](https://lehd.ces.census.gov/LEHD_data_research.html)) data from the Census Bureau.
  + Joining to a grid cell is likewise straightforward. By providing an equal-area grid cell to join to, spatial analysis is greatly facilitated (as area does not need to be used as a co-variate). 

```{r summarytables, eval=TRUE, include=FALSE}
# Values for intro text

waze_sum1 <- d %>% 
  summarize(crashes = sum(crash_n, na.rm = T),
            wehs = sum(weh_n, na.rm = T),
            jams = sum(jam_n, na.rm = T),
            total_waze = crashes + wehs + jams
            )




```

 
For most safety applications, it is ideal to work at the road segment level, since that is where safety interventions can be applied. For our initial work, we elected to use a grid to facilitate rapid analysis for the purpose of comparing the two data sets in conjunction with each other. We joined all point data (FMI and Waze) to grid layer of 1 square-mile hexagons. Hexagonal tessellations are appropriate because they better represent underlying linear features like roads, while minimizing the data artifacts associated with edge areas ([ESRI reference](https://pro.arcgis.com/en/pro-app/tool-reference/spatial-statistics/h-whyhexagons.htm)). The area of eastern Massachusetts selected here encompasses `r format(length(unique(d$GRID_ID)), big.mark = ',')` square miles. For the month of September 2019, data on `r format(sum(d$truck_n, na.rm = T), big.mark = ',', scientific = F)` unique trucks by hour were included from the FMI data, as well `r format(waze_sum1$total_waze, big.mark = ',', scientific = F)` unique Waze events by hour.

Code for this project was written in SQL, Python, and R, and is version-controlled in the `FMI_Waze` repository on the GitLab service within SDC.

# Results

## Mapping

The following maps show aggregated counts of unique truck IDs per hour and counts of Waze events per hour. The spatial unit is 1-square mile hexagonal grid cells. A road segment approach using the HPMS network or a more detailed state-provided network is possible in the future.

These maps further aggregate the count of each  to daytime (7 am to 7pm, Eastern) and weekend/weekday time periods for ease of comparison.

### Weekdays {.tabset .tabset-pills}

Comparing daytime to nighttime, the FMI data show consistent patterns but less total volume in the evening. The mean count of unique truck IDs per hour ranges as high as 106, and high values are consistently observed along the interstate 495 and interstate 90 routes ([Google Map of the area](https://www.google.com/maps/place/Massachusetts/@42.1578263,-71.5714201,9z/data=!4m5!3m4!1s0x89e3656de973bffd:0x45c6d03655830d1c!8m2!3d42.4072107!4d-71.3824374)). While interstates appear prominently in the FMI data, there is even coverage across the entire study area for presence of trucking activity.

When clicking the `Waze Alert Counts` tab, a strikingly different pattern emerges. Note the scale differs between the FMI and Waze tabs. The dense cluster of Waze alert activity in the metro Boston area is maintained in both daytime and nighttime, but much less activity is observed in the nighttime. 

#### FMI Truck Counts

```{r day_fmi, out.height = "400px"}
# 1 = weekday /nighttime
# 2 = weekday / daytime
# 3 = weekend / nightitme
# 4 = weekend / daytime
knitr::include_graphics('images/Truck_count_plots_Page_2.jpg')
knitr::include_graphics('images/Truck_count_plots_Page_1.jpg')

```

#### Waze Alert Counts

```{r day_waze, out.height = "400px"}
knitr::include_graphics('images/Waze_count_plots_Page_2.jpg')
knitr::include_graphics('images/Waze_count_plots_Page_1.jpg')

```

### Weekend {.tabset .tabset-pills}

The patterns on the weekends are similar for both FMI and Waze. Note that the scale is the same for the weekday plots within each data set (FMI and Waze), but remains different across data sets. The FMI data show distinct patches of high activity on weekends, which may represent distribution centers or other warehouses. Waze activity is reduced on weekends, and distinct patches of high activity likewise emerge.

#### FMI Truck Counts

```{r day_fmi2, out.height = "400px"}
knitr::include_graphics('images/Truck_count_plots_Page_4.jpg')
knitr::include_graphics('images/Truck_count_plots_Page_3.jpg')
```

#### Waze Alert Counts

```{r day_waze2, out.height = "400px"}
knitr::include_graphics('images/Waze_count_plots_Page_4.jpg')
knitr::include_graphics('images/Waze_count_plots_Page_3.jpg')

```


### FMI Truck Speeds {.tabset .tabset-pills}

Note these maps compare just weekday and weekend time periods for mean speeds of unique truck IDs within a grid cell. 
The mean speed of a given truck ID was first calculated; these values are the means of those mean values by truck ID.
Truck speeds are generally lower in the Boston metro area, with the interstate areas contributing some of the highest speed. Speeds generally retain the same characteristics on weekdays and weekends.

#### Weekday

```{r day_truckspeed, out.height = "400px"}
knitr::include_graphics('images/Truck_speed_plots_Page_2.jpg')
knitr::include_graphics('images/Truck_speed_plots_Page_1.jpg')
```


#### Weekend

```{r end_truckspeed, out.height = "400px"}
knitr::include_graphics('images/Truck_speed_plots_Page_4.jpg')
knitr::include_graphics('images/Truck_speed_plots_Page_3.jpg')

```


```{r aggregate}
d_a <- d %>%
  group_by(GRID_ID, weekend, daytime) %>%
  summarize(sum_count = sum(truck_n, na.rm = T),
            sum_obs = sum(!is.na(truck_n)),
            mean_count = sum_count / sum_obs,
            mean_speed = mean(speed_mean, na.rm = T),
            median_speed = median(speed_median, na.rm = T),
            sum_crash = sum(crash_n, na.rm = T),
            sum_weh = sum(weh_n, na.rm = T),
            sum_jam = sum(jam_n, na.rm = T),
            sum_roadclose = sum(roadclose_n, na.rm = T),
            sum_waze_obs = sum(!is.na(crash_n)),
            mean_crash = sum_crash / sum_waze_obs,
            mean_jam = sum_jam / sum_waze_obs,
            mean_weh = sum_weh / sum_waze_obs,
            mean_roadclose = sum_roadclose / sum_waze_obs,
            sum_all_waze = (sum_crash + sum_weh + sum_jam + sum_roadclose),
            mean_all_waze =  sum_all_waze / sum_waze_obs
  )
            

d_a$weekend <- factor(d_a$weekend, labels = c('Weekday', 'Weekend'))
d_a$daytime <- factor(d_a$daytime, labels = c('Nighttime', 'Daytime'))


```

## Volume relationships

We additionally assessed the relationship between the two data sets in terms of the volume of data. A high correspondence in data volume indicates that when analyzed by equal-area grid cell and hour, generally high activity in one stream of data is matched by high activity in the other. Each point in the figures below represents one grid cell. Values are the sum of distinct truck IDs or unique Waze alerts for the specified time frame (weekend or weekday, daytime or nighttime) in that grid cell.

```{r volume, fig.width = 8, fig.height= 10}
gp <- ggplot(d_a, aes(x = round(sum_count, 1), y = round(sum_all_waze, 1))) +
  geom_point(alpha = 0.1,
             #, aes(size = sum_obs)
             aes(text = paste('FMI count:', sum_count, '\nWaze count:', sum_all_waze,
                              '\nGrid ID:', GRID_ID))) +
  theme_bw() +
  facet_wrap(~weekend+daytime) +
  geom_smooth(method = 'lm') +
  ylab('Sum hourly counts of Waze reports by grid cell') +
  xlab('Sum hourly counts of FMI truck reports by grid cell') +
  ggtitle('Relationship between FMI and Waze data volume by grid cell')

ggplotly(gp, tooltip = 'text', width = 700, height = 600)

```

Since both axes represent highly skewed data (few, very large values), it is also useful to view these relationships on a logarithmic scale. This demonstrates close correspondence between the volume of FMI and volume of Waze alert data when accounting for the distribution of the values.

```{r volume_log, fig.width = 8, fig.height= 10}
gpl <- gp + scale_y_log10() + scale_x_log10()

ggplotly(gpl, tooltip = 'text', width = 700, height = 600)

```



## Waze jams and truck speeds



```{r aggregate_jam}
d_j <- d %>%
  mutate(high_jams = ifelse(jam_n > 2 & !is.na(jam_n), 'High Jams', 'Low Jams')) %>%
  group_by(GRID_ID, weekend, hour, high_jams) %>%
  summarize(sum_count = sum(truck_n, na.rm = T),
            sum_obs = sum(!is.na(truck_n)),
            mean_count = sum_count / sum_obs,
            mean_speed = mean(speed_mean, na.rm = T),
            median_speed = median(speed_median, na.rm = T),
            sum_crash = sum(crash_n, na.rm = T),
            sum_weh = sum(weh_n, na.rm = T),
            sum_jam = sum(jam_n, na.rm = T),
            sum_roadclose = sum(roadclose_n, na.rm = T),
            sum_waze_obs = sum(!is.na(crash_n)),
            mean_crash = sum_crash / sum_waze_obs,
            mean_jam = sum_jam / sum_waze_obs,
            mean_weh = sum_weh / sum_waze_obs,
            mean_roadclose = sum_roadclose / sum_waze_obs,
            sum_all_waze = (sum_crash + sum_weh + sum_jam + sum_roadclose),
            mean_all_waze =  sum_all_waze / sum_waze_obs
  )
            

d_j$weekend <- factor(d_j$weekend, labels = c('Weekday', 'Weekend'))

# test: d_j %>% ungroup() %>% group_by(high_jams) %>% summarize(median(sum_jam))
# table(d_j$high_jams)
```

The following plot and table demonstrate that the two data sets can be combined in useful ways. When at least 3 jam reports are present in the Waze data, there is a dramatic drop in the speeds of trucks in the FMI data. The boxplots below group truck speeds into five categories, and the y-axis represents the mean count of distinct truck IDs per grid cell for that time period and number of jams. Note that 'low jams' represents most of the data, `r format(table(d_j$high_jams)[2], big.mark = ',')` grid cells x weekend/weekday time period, while 'high jams' is a less common condition, only `r format(table(d_j$high_jams)[1], big.mark = ',')` grid cells x weekend/weekday time period.



```{r plot_jams}
gj <- ggplot(d_j %>% filter(!is.na(median_speed)), aes(x = cut(na.omit(median_speed), 5), y = sum_count)) + 
  geom_boxplot() +
  scale_y_log10() +
  xlab('Median speed grouping') +
  ylab('Log(N) of distinct truck IDs') +
  facet_wrap(~weekend + high_jams) +
  ggtitle('Truck speeds and counts by Waze jam reports')

gj  

```

The same data are summarized below in tabular form for quick reference.

```{r table_jams}
sum_tab = d_j %>%
  ungroup() %>%
  group_by(weekend, high_jams) %>%
  summarize(`Number of grid cell x time combinations` = n(),
            `Median FMI truck speeds` = median(median_speed, na.rm = T),
            `Sum FMI truck counts` = sum(sum_count, na.rm = T),
            `Median Waze jam reports` = median(sum_jam, na.rm = T),
            `Sum all Waze reports` = sum(sum_all_waze, na.rm = T),
            )


kable(sum_tab,
      format.args = list(big.mark = ','),
      caption = "Summary of FMI and Waze data by weekend/weekday and high Waze jam counts" ) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(nrow(sum_tab), bold = F, hline_after = T)


```


# Next Steps 

Next steps will be considered in consultation with the project manager and stakeholders. We consider the following to represent potentially fruitful next steps:

- **Pandemic response**
  + The FMI data represents an unprecedented opportunity for USDOT to monitor and understand commercial motor vehicle activity. The COVID-19 pandemic is a natural experiment on all aspects of society, but in particular is affecting the trucking industry in distinct ways, with some states seeing spikes at the outset of the pandemic, followed by dips in trucking activity of different depths ([ATRI analysis](https://www.ttnews.com/articles/atri-coronavirus-study-shows-truck-activity-spike-dip-six-states)). 
  
  + Combining the Waze and FMI data would provide a way for the department to understand and monitor the distinctive behaviors of commuters versus commercial motor vehicles as our country recovers from the pandemic.
  
- **Travel time / Mobility / Energy **
  + System-generated jam files from Waze include the spatial extent as well as severity of the jam. Looking at the influence of jams on freight travel from FMI could be fruitful.
  
  + Fuel efficiency and truck platooning are possible to investigate using the FMI data, since unique truck IDs are available with GPS pings at high frequency.

- **Safety**
  + Crash predictability (with police crash report data). The Waze data has been successfully used to understand and predict crash frequency at broad spatial scales. Combining both Waze and FMI could support a crash prediction tool for commercial motor vehicles better than using either one of the data sets alone.

- (*Assessment of data and validation**
  + WYDOT Speed data to NPM-RDS. The Connected Vehicle Pilot in SDC has detailed vehicle speed data from Wyoming Department of Transportation. These data could be usefully validated against speed profile data for NHS road segments in the National Performance Management Research Data Set ([NPM-RDS](https://ops.fhwa.dot.gov/perf_measurement/)) from FHWA.

  + TMAS to FMI. The Traffic Monitoring Analysis System ([TMAS](https://www.fhwa.dot.gov/policyinformation/tables/tmasdata/)) from FHWA provides ground-truthed traffic count and vehicle classification data at over 8,000 locations nationwide. Joining TMAS and FMI data would allow an understanding of the percent of all trucks which are represented in the FMI data by space and time.

  + TMAS to Waze (under SDI). The Safety Data Initiative is now undertaking an analysis of the Waze data in the context of the TMAS data as noted above for FMI. This will provide confidence intervals for how much of the traveling public is represented in the Waze data.



